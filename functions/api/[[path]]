// Proxies /api/* from your Pages site to your Worker.
// Injects DEVICE_TOKEN only for POST /api/ingest.

export const onRequest: PagesFunction = async (ctx) => {
  const API_BASE = ctx.env.WORKER_ORIGIN as string;  // e.g. https://dht11-api.testarosa.workers.dev
  const req = ctx.request;
  const inUrl = new URL(req.url);

  // forward /api/* to Worker /api/*
  const sub = inUrl.pathname.replace(/^\/api\//, "");
  const target = new URL(`${API_BASE}/api/${sub}`);
  target.search = inUrl.search;

  // copy headers; add token only for ingest POST
  const hdrs = new Headers(req.headers);
  if (inUrl.pathname === "/api/ingest" && req.method.toUpperCase() === "POST") {
    hdrs.set("X-DEVICE-TOKEN", String(ctx.env.DEVICE_TOKEN));
  }

  const resp = await fetch(target.toString(), {
    method: req.method,
    headers: hdrs,
    body: ["GET","HEAD"].includes(req.method.toUpperCase()) ? undefined : req.body
  });

  const out = new Headers(resp.headers);
  if (!out.get("content-type")) out.set("content-type","application/json");
  return new Response(resp.body, { status: resp.status, headers: out });
};
