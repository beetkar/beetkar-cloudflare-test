<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DHT11 Live Readings (Adjustable Charts)</title>
  <style>
    :root{ --card-b: #e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid var(--card-b); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    h1 { margin-top: 0; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 280px; }
    .val { font-size: 2.6rem; font-weight: 700; }
    .muted { color: var(--muted); }
    input, select { padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; cursor: pointer; }
    canvas { width: 100%; height: 320px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left; font-variant-numeric: tabular-nums; }
    .table-wrap { max-height: 320px; overflow: auto; border: 1px solid #eee; border-radius: 12px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:end; }
    .pill { display:flex; gap:6px; align-items:center; }
    .pill label { font-size: 12px; color: var(--muted); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <h1>DHT11 Live (Cloudflare)</h1>

  <!-- Controls -->
  <div class="card">
    <div class="row">
      <div class="col">
        <label>API base URL</label>
        <input id="baseUrl" style="width:100%" value="https://YOUR_SUBDOMAIN.workers.dev">
        <small class="muted">e.g. https://dht11-api.yourname.workers.dev</small>
      </div>
      <div class="col">
        <label>Device ID</label>
        <input id="deviceId" style="width:100%" value="esp32-01">
      </div>
      <div class="col controls">
        <div class="pill">
          <label for="rangeSel">Range</label>
          <select id="rangeSel">
            <option value="30m">30m</option>
            <option value="2h">2h</option>
            <option value="6h" selected>6h</option>
            <option value="24h">24h</option>
            <option value="3d">3d</option>
            <option value="7d">7d</option>
          </select>
        </div>
        <div class="pill">
          <label for="bucketSel">Bucket</label>
          <select id="bucketSel">
            <option value="auto" selected>auto</option>
            <option value="minute">minute</option>
            <option value="hour">hour</option>
            <option value="day">day</option>
          </select>
        </div>
        <div class="pill">
          <label for="limitSel">Fetch</label>
          <select id="limitSel">
            <option value="200">200 rows</option>
            <option value="500" selected>500 rows</option>
            <option value="2000">2000 rows</option>
          </select>
        </div>
      </div>
      <div class="col controls">
        <div class="pill">
          <label for="intervalSel">Auto</label>
          <select id="intervalSel">
            <option value="0">off</option>
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="30">30s</option>
            <option value="60">60s</option>
          </select>
        </div>
        <button id="refresh">Refresh</button>
        <button id="downloadCsv">Download CSV</button>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="card">
    <strong>Charts</strong>
    <div class="row">
      <div class="col"><canvas id="tempChart"></canvas></div>
      <div class="col"><canvas id="humChart"></canvas></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row">
    <div class="card col">
      <div class="muted">Temperature (°C)</div>
      <div id="tempVal" class="val">--</div>
      <div id="tempTs" class="muted">—</div>
    </div>
    <div class="card col">
      <div class="muted">Humidity (%)</div>
      <div id="humVal" class="val">--</div>
      <div id="humTs" class="muted">—</div>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <strong>Recent readings</strong>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Time</th><th>Temp (°C)</th><th>Humidity (%)</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
const $ = id => document.getElementById(id);
let timer=null, tempChart, humChart, cachedRows=[];

function parseRange(str){
  const now = Date.now();
  const n = Number(str.slice(0, -1));
  const unit = str.slice(-1);
  let ms = 0;
  if(unit === 'm') ms = n*60*1000;
  if(unit === 'h') ms = n*60*60*1000;
  if(unit === 'd') ms = n*24*60*60*1000;
  return {from: now - ms, to: now};
}

function floorToBucket(ts, bucket){
  const d = new Date(ts);
  if(bucket === 'minute'){
    d.setSeconds(0,0);
  } else if(bucket === 'hour'){
    d.setMinutes(0,0,0);
  } else if(bucket === 'day'){
    d.setHours(0,0,0,0);
  } else {
    // auto: leave as-is (no bucketing)
  }
  return d.getTime();
}

function chooseAutoBucket(rangeStr){
  // heuristics: <=2h -> minute; <=24h -> hour; otherwise day
  if(rangeStr.endsWith('m') || rangeStr === '2h') return 'minute';
  if(rangeStr === '6h' || rangeStr === '24h') return 'hour';
  return 'day';
}

function aggregate(rows, rangeStr, bucketSel){
  // filter by time window
  const {from, to} = parseRange(rangeStr);
  const filtered = rows.filter(r => new Date(r.ts).getTime() >= from);

  const bucket = bucketSel === 'auto' ? chooseAutoBucket(rangeStr) : bucketSel;
  if(bucket === 'auto'){
    return filtered.map(r => ({ x:new Date(r.ts).getTime(), t:+r.temp_c, h:+r.humidity }));
  }

  // group by floored ts
  const map = new Map();
  for(const r of filtered){
    const key = floorToBucket(r.ts, bucket);
    const prev = map.get(key) || {sumT:0, sumH:0, n:0};
    prev.sumT += +r.temp_c;
    prev.sumH += +r.humidity;
    prev.n += 1;
    map.set(key, prev);
  }
  // to array sorted by time
  const points = Array.from(map.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>({
    x: Number(k),
    t: v.sumT / v.n,
    h: v.sumH / v.n
  }));
  return points;
}

function buildCharts(){
  const common = {
    parsing:false, animation:false,
    plugins:{legend:{display:true}},
    scales:{
      x:{type:'time', time:{tooltipFormat:'PPpp'}},
      y:{beginAtZero:false}
    }
  };
  tempChart = new Chart($('tempChart').getContext('2d'), {
    type:'line',
    data:{datasets:[{label:'Temp °C', data:[]}]},
    options: common
  });
  humChart = new Chart($('humChart').getContext('2d'), {
    type:'line',
    data:{datasets:[{label:'Humidity %', data:[]}]},
    options:{...common, scales:{ x:{type:'time', time:{tooltipFormat:'PPpp'}}, y:{beginAtZero:true, max:100} }}
  });
}

function updateChartsFromCached(){
  const rangeStr = $('rangeSel').value;
  const bucketSel = $('bucketSel').value;
  const agg = aggregate(cachedRows, rangeStr, bucketSel);
  // map to chart.js points
  const tpts = agg.map(p=>({x:p.x, y:Number(p.t)}));
  const hpts = agg.map(p=>({x:p.x, y:Number(p.h)}));
  tempChart.data.datasets[0].data = tpts;
  humChart.data.datasets[0].data = hpts;

  // set unit hint to improve tick labeling
  const unit = bucketSel === 'auto' ? chooseAutoBucket(rangeStr) : bucketSel;
  const xConfT = tempChart.options.scales.x;
  const xConfH = humChart.options.scales.x;
  xConfT.time.unit = unit === 'minute' ? 'minute' : unit === 'hour' ? 'hour' : 'day';
  xConfH.time.unit = xConfT.time.unit;

  tempChart.update();
  humChart.update();
}

async function loadLatest(){
  const base=$('baseUrl').value.trim().replace(/\/+$/,'');
  const deviceId=$('deviceId').value.trim();
  const r=await fetch(`${base}/api/latest?deviceId=${encodeURIComponent(deviceId)}`);
  const data=await r.json();
  if(data.latest){
    $('tempVal').textContent=Number(data.latest.temp_c).toFixed(1);
    $('humVal').textContent=Number(data.latest.humidity).toFixed(1);
    $('tempTs').textContent=new Date(data.latest.ts).toLocaleString();
    $('humTs').textContent=new Date(data.latest.ts).toLocaleString();
  } else {
    $('tempVal').textContent='--'; $('humVal').textContent='--';
    $('tempTs').textContent='No data yet'; $('humTs').textContent='No data yet';
  }
}

async function loadList(){
  const base=$('baseUrl').value.trim().replace(/\/+$/,'');
  const deviceId=$('deviceId').value.trim();
  const limit=Number($('limitSel').value);
  const r=await fetch(`${base}/api/readings?deviceId=${encodeURIComponent(deviceId)}&limit=${limit}`);
  const data=await r.json();
  const rows = data.rows || [];
  cachedRows = rows;

  $('rows').innerHTML = rows.map(r=>`
    <tr>
      <td>${new Date(r.ts).toLocaleString()}</td>
      <td>${Number(r.temp_c).toFixed(1)}</td>
      <td>${Number(r.humidity).toFixed(1)}</td>
    </tr>
  `).join('');

  updateChartsFromCached();
}

function setIntervalFromSelect(){
  const s=Number($('intervalSel').value);
  if(timer) clearInterval(timer);
  if(s>0) timer=setInterval(()=>{loadLatest();loadList();}, s*1000);
}

$('downloadCsv').addEventListener('click', ()=>{
  const rows = cachedRows.slice().reverse();
  let csv="timestamp,temp_c,humidity\n";
  rows.forEach(r=>{
    csv+=`${new Date(r.ts).toISOString()},${Number(r.temp_c)},${Number(r.humidity)}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`readings_${$('deviceId').value.trim()}_${Date.now()}.csv`;
  a.click();
});

// Re-render on control changes
['rangeSel','bucketSel','limitSel'].forEach(id=>{
  $(id).addEventListener('change', ()=>{
    if(id==='limitSel'){ loadList(); } else { updateChartsFromCached(); }
  });
});
$('refresh').addEventListener('click', ()=>{ loadLatest(); loadList(); });
$('intervalSel').addEventListener('change', setIntervalFromSelect);

buildCharts();
loadLatest().then(loadList).then(setIntervalFromSelect);
</script>
</body>
</html>
